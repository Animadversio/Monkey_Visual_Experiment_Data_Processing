%% Corr_interpretation (Kinda obsolete.... use python interface)
exportONNXNetwork(net,"N:\vgg16mat.onnx")
%% Python interface building
% compare the vgg16 in matlab vs that in python

pe = pyenv('Version','C:\ProgramData\Anaconda3\envs\tf-torch\python.exe'); % Set up the python executable
py.importlib.import_module('torch');
py.importlib.import_module('torchvision');
py.importlib.import_module('torchvision.models'); % Load some deep learning framework
pyvgg = py.torchvision.models.vgg16(pyargs("pretrained",1)); % Load a pretrained neural net 
% out = SNet.forward(py.torch.rand(py.int(1),py.int(3),py.int(224),py.int(224))); % process sth in python torch framework
% out.data.numpy().double();
%%
matvgg = vgg16;
% matlab doesn't have std rescale, only 0 mean centered
RGBmean = [123.6800  116.7790  103.9390];squeeze(matvgg.Layers(1).Mean(1,1,:));
%%
vggmatW = struct();
for i=1:numel(matvgg.Layers)
%     fprintf(layer.Name) 
    layer = matvgg.Layers(i);
    if any(strcmp('Weights', fieldnames(layer)))
        fprintf("%s:W [%s], B [%s]\n",layer.Name,num2str(size(layer.Weights)),num2str(size(layer.Bias))) 
%         vggmatW.(compose("%s_num",layer.Name)) = i;
        vggmatW.(compose("%s_weight",layer.Name)) = layer.Weights;
        vggmatW.(compose("%s_bias",layer.Name)) = layer.Bias;
    end
end
save("N:\vgg16W.mat","vggmatW","-v6")
%%
pyact = [-1.7149e+00,  9.2810e-01, -3.4734e+00, -2.7381e+00, -1.6791e+00,
          1.2822e+00, -2.9655e+00,  5.5040e-01,  2.5513e+00, -1.3666e+00,
          3.8473e-03, -7.1907e-01,  8.3689e-01,  3.4857e-01, -1.4339e+00,
         -3.7491e-02,  4.7969e-02,  1.1575e+00, -8.1646e-01, -2.0938e+00,
         -1.6838e+00,  6.6261e-01, -2.4059e+00, -2.5987e+00, -2.9125e+00,
         -2.3321e+00, -8.4387e-01,  1.6489e-01, -3.1804e+00, -1.4833e+00,
         -1.6924e+00, -8.7561e-01, -2.1641e+00, -3.2880e+00, -3.3914e+00,
         -2.0090e+00, -1.5950e+00, -1.1319e+00,  3.2134e-01, -1.7847e+00,
          3.1112e+00, -1.2570e+00,  2.7180e-01, -1.4694e+00,  1.5558e+00,
         -3.2772e+00,  2.9893e+00, -4.0160e-01, -4.1402e+00, -4.0742e+00,
         -2.4997e+00, -7.1818e-01,  1.0106e+00,  4.4845e-01,  2.1040e+00,
          9.8524e-01,  9.5924e-02, -1.3149e+00,  6.4409e-01,  2.4453e+00,
          1.9235e+00, -9.9014e-01, -1.5088e+00,  4.5304e-01, -5.4282e-01,
         -2.7580e+00,  2.2263e+00,  5.8703e-01, -2.2122e-02, -3.0730e+00,
          2.0323e+00, -1.5230e+00, -6.7969e-01, -8.1299e-01, -3.8301e-01,
         -1.2068e+00, -5.7418e-01,  1.3986e-01,  5.2885e-02,  4.9119e-01,
         -2.7596e+00, -3.7059e+00,  2.6798e+00, -1.3503e-01, -1.4926e+00,
          2.0530e-01,  2.3011e+00, -3.0262e+00, -1.7316e+00, -2.5437e+00,
         -1.8620e+00, -9.0047e-01, -9.2201e-01, -4.8253e-01,  9.1441e-01,
         -2.0490e+00, -1.4683e+00,  6.0298e-01,  4.6144e-01,  1.2008e+00,
         -1.8341e+00, -5.9637e+00, -2.0327e+00, -8.9065e-01,  3.0651e+00,
         -9.9193e-01,  6.0213e-01, -2.5609e+00, -1.7296e-01, -2.1204e+00,
         -1.4690e+00, -1.3892e+00, -1.6007e+00,  9.8892e-01,  2.2728e+00,
         -1.4350e+00, -2.2016e+00, -1.4171e+00, -2.9585e-01, -2.9374e+00,
         -3.3189e+00, -2.7890e+00, -2.3503e+00, -3.9195e+00, -5.7744e-01,
         -2.1118e+00, -2.7519e+00, -3.4808e+00, -3.6392e+00, -3.2863e+00,
          1.3276e-02, -1.3718e+00, -3.8407e-01,  2.3774e+00,  4.4662e-01,
         -9.0654e-01, -6.5241e-02, -9.1633e-01, -7.8314e-01, -2.8896e+00,
         -1.4869e+00, -5.3304e-01, -2.0877e+00, -2.2186e+00, -3.4442e+00,
         -4.6940e-01, -2.4052e+00, -4.6636e+00, -2.4419e+00, -3.4072e+00,
         -1.3527e+00,  4.9890e+00, -2.9024e-01, -1.0365e+00,  1.4244e+00,
          9.9942e-03, -9.3464e-02,  2.8844e-01,  1.2655e+00, -1.1025e+00,
         -2.2607e+00, -1.0187e+00,  2.8760e-01, -7.3862e-01, -2.3918e+00,
         -3.3958e+00, -2.5188e+00, -1.0841e+00,  1.3500e+00, -3.4726e+00,
         -3.1034e+00, -2.3384e-02, -3.1667e+00,  2.1072e+00, -1.5313e+00,
         -1.4320e+00, -2.2246e+00, -3.3812e+00, -8.0827e-01, -2.9406e+00,
         -1.4246e+00, -3.0352e+00,  1.0889e+00, -2.7992e+00,  1.8768e-01,
          3.3995e+00,  5.2112e+00,  1.9151e+00, -6.2011e-01,  5.1678e-01,
         -3.7672e+00, -9.1795e-03,  5.0402e-01,  2.2843e+00, -1.1259e+00,
         -6.7927e-01, -2.0714e+00, -2.6432e+00, -3.5271e+00, -3.1619e-01,
         -1.1884e+00,  5.9639e-01, -8.6246e-01,  3.1835e-02, -1.1370e-01,
         -1.8426e+00, -2.8558e+00,  1.6951e+00,  1.2569e+00, -5.6387e-01,
         -3.6679e+00,  1.4271e+00, -1.9753e+00, -8.0654e-01, -2.0918e+00,
         -8.4767e-01, -2.7688e+00, -2.5742e+00,  7.6584e-01, -7.7913e-01,
         -9.8407e-01, -3.2429e+00, -2.3164e+00,  5.5461e-03, -1.0499e+00,
         -8.2141e-02, -1.5268e+00,  1.4700e+00, -5.3920e+00, -2.1635e+00,
          6.0299e-02,  6.8235e-01, -6.6679e-01, -2.2906e+00, -9.0183e-01,
          6.6565e-01, -1.6240e+00,  1.0192e+00, -6.9686e-02, -6.2367e-01,
         -2.2559e-01, -2.1176e+00, -2.1055e+00, -1.6737e+00, -2.1039e+00,
          8.7518e-01, -2.5860e+00, -8.5829e-01,  1.9362e+00,  1.8053e-01,
          1.8634e+00, -6.4145e-01, -1.2620e+00,  1.8688e+00, -1.0886e+00,
         -1.3323e+00, -1.7977e+00, -2.4724e+00, -2.0958e+00,  3.9747e+00,
          3.0686e-01, -2.8218e+00,  2.0305e+00,  4.4899e+00,  3.2792e+00,
          8.5028e-01, -1.4916e+00, -2.1961e+00, -1.4198e+00, -2.0953e+00,
         -1.5138e+00,  1.0087e+00,  1.4886e+00,  1.9938e+00,  3.7200e+00,
         -2.5341e+00, -1.1543e+00,  6.0734e+00,  6.6857e+00,  5.9591e-01,
          3.2084e+00,  1.1057e+01,  1.1200e+01,  6.4591e+00,  6.3941e+00,
          1.0444e+01,  1.7168e+00,  8.5542e+00,  5.6766e-02, -2.6149e+00,
         -5.7893e-01,  2.0473e-01,  1.0296e+00,  1.1646e+00, -2.9186e+00,
         -1.5355e+00, -2.8762e+00, -5.6925e+00,  3.4806e+00,  2.0700e+00,
         -2.9265e+00, -2.4562e-01, -3.7668e+00, -2.2650e+00, -3.4148e+00,
         -4.1308e+00, -2.4272e+00, -4.7069e+00, -1.2334e+00, -6.3398e-01,
         -2.7072e-01,  6.3798e-01,  2.6459e-03, -9.3261e-02, -8.8293e-01,
          6.3067e-01, -1.9192e+00, -1.5038e+00, -1.0015e+00,  2.0976e-01,
         -1.5951e-01, -9.3674e-01,  1.7538e+00, -1.1207e+00, -1.2114e+00,
         -4.5087e-02,  1.3094e+00,  1.6159e+00, -1.3590e+00, -2.8655e+00,
          5.8219e+00,  5.6859e+00,  5.4968e+00,  5.3648e+00, -1.4361e+00,
          3.0217e+00,  3.9466e-01,  6.6673e-02,  1.3249e+00, -2.8795e+00,
         -8.5291e-01, -1.5401e+00, -2.1764e+00, -4.9672e+00, -3.3448e+00,
         -4.1163e+00, -4.6364e+00, -4.3544e+00, -4.0692e+00, -4.2659e+00,
         -2.3463e+00, -2.4839e+00,  4.1265e-01,  4.8593e-01, -4.5241e+00,
         -3.0399e-01,  6.0308e+00,  2.9885e+00,  3.3652e+00,  2.0659e+00,
          1.4460e+00, -6.7691e-01, -6.0022e-01, -6.1464e-01, -2.0803e+00,
         -1.0458e+00, -3.8893e+00, -2.6453e+00,  2.9404e-01, -1.4927e+00,
         -1.0158e+00, -4.3698e-01, -3.6370e+00,  8.3740e-01, -3.4071e-01,
         -3.7568e+00, -4.8010e-01,  9.0513e-01,  1.5269e+00, -4.1590e-01,
          1.6596e+00, -4.3283e-03,  5.7153e-01,  4.9659e-02,  7.9693e-01,
         -5.1241e+00, -4.0843e+00,  2.1600e+00, -1.8867e+00, -1.7160e+00,
         -2.8650e+00, -1.0183e+00, -1.9490e+00, -1.8820e+00, -3.0925e+00,
         -9.0342e-01, -2.1753e+00, -3.0724e+00,  1.1667e+00, -3.2097e-01,
         -2.0935e+00, -2.0366e+00, -6.3180e-01, -3.6051e+00, -2.1125e+00,
         -2.5744e+00, -1.2820e+00, -2.7733e+00, -9.3284e-01,  7.1019e-01,
         -1.6966e+00,  2.2383e+00,  5.8053e+00, -1.7384e+00,  2.4425e+00,
          2.1058e-01, -1.5695e+00,  6.5790e-01,  5.6458e-01,  3.4025e+00,
         -5.0341e-01, -3.8988e-02,  2.2133e+00,  1.0119e+00, -1.3225e-02,
         -9.4245e-01, -5.8848e-01,  1.9220e+00,  3.8831e+00,  1.8479e+00,
          8.2297e-02,  2.8860e+00, -2.7348e+00, -2.2130e-01,  3.8189e+00,
          3.7502e+00, -8.4852e-01, -2.6085e+00,  3.5917e+00, -9.0150e-01,
          1.4061e+00,  1.6259e+00, -2.0772e+00,  3.3450e+00, -3.4526e+00,
         -1.4378e+00,  1.9974e+00, -1.5992e-01,  8.4984e-01, -2.3317e+00,
         -3.9544e+00, -2.2439e+00,  2.0773e+00,  3.1756e+00,  1.9814e+00,
          2.1665e+00,  3.1202e-01,  5.6556e+00, -1.8777e+00,  1.1494e+00,
         -2.0720e+00, -2.8197e+00,  2.4465e+00,  6.5959e+00, -2.0120e-01,
         -1.3532e-01, -2.6781e+00, -1.2070e+00, -2.9512e-01,  2.3550e+00,
          2.7527e+00, -2.4954e+00, -1.4111e-01,  1.8483e+00, -9.6803e-01,
          1.2951e+00, -2.2642e+00,  7.1978e-01,  6.8585e+00,  2.8924e+00,
          1.4294e-01, -7.0706e-01, -1.3177e+00, -1.9298e+00, -1.9122e+00,
          1.1573e+00, -1.5561e+00,  2.6345e+00, -1.6389e+00,  3.7728e-01,
         -1.2834e+00, -1.3725e+00,  1.2561e+00, -7.4845e-01, -1.0165e+00,
         -1.4280e+00,  1.2649e+00, -9.4613e-01, -2.8405e+00, -1.5705e-01,
         -2.6264e+00, -5.9481e-01,  3.9730e-01,  5.0106e-01,  4.5071e+00,
          1.1350e+00,  4.5201e-01,  1.0075e-01,  6.0600e+00, -3.9982e-01,
         -1.7767e+00, -2.6003e+00, -9.9979e-01, -3.7845e+00,  1.3599e+00,
          3.8801e+00,  2.9595e+00, -1.4303e+00,  5.1614e-01,  4.5592e+00,
          2.3814e+00,  5.4482e+00, -4.5756e-01, -2.1404e+00, -2.8401e+00,
         -2.8263e+00,  3.2576e+00,  3.0332e+00,  7.3209e-01, -5.2787e-01,
          2.9375e+00, -7.8165e-01,  2.1014e+00,  1.1133e+00,  5.4535e+00,
         -1.6629e+00,  3.5448e-02, -4.2051e+00, -4.3322e-01,  6.1795e+00,
         -3.3907e+00, -3.0518e-01,  1.0993e+00,  5.4602e+00,  1.9826e+00,
          1.7245e+00,  7.7273e-01, -4.6171e+00,  1.1020e+00,  2.7766e+00,
          5.2531e-01,  2.7723e+00,  3.8970e+00,  2.9806e+00, -3.2749e+00,
         -3.1945e+00,  5.7311e-01, -9.4318e-01, -1.9105e+00,  3.1716e+00,
         -8.1164e-01, -1.4341e+00,  2.0662e-01,  5.4620e-01, -1.4735e+00,
         -1.0078e+00, -7.7758e-01,  3.3520e+00, -1.0653e+00, -3.8493e+00,
         -2.3441e+00, -1.9251e+00,  9.7632e-01, -2.9503e+00,  1.9260e+00,
         -8.0800e-01, -2.2870e+00, -8.1508e-01, -1.2637e+00, -1.0307e+00,
          1.1470e+00,  2.7457e-01,  1.5054e+00, -1.2595e+00,  3.4597e-01,
          2.6747e-02, -2.1906e+00,  1.9241e+00,  6.1339e+00,  5.9253e-01,
          9.7537e-01,  7.4935e-01,  2.6465e+00,  8.8444e-01, -4.3659e-01,
         -2.5976e+00,  2.1651e+00, -5.3266e-01, -1.1961e-01,  1.0982e+00,
          1.5295e+00, -1.5127e+00,  4.0176e-01, -4.0551e+00, -8.0156e-01,
          2.7986e+00,  2.3832e+00,  8.1316e-01,  6.3149e-01, -2.5354e+00,
         -9.8262e-01,  4.4874e+00, -2.7636e+00,  2.5765e-01,  5.9534e-01,
         -4.8597e-01,  6.9183e-01, -1.1223e-02,  3.5142e+00,  2.6639e+00,
          6.4170e+00,  1.1521e+00,  6.9828e+00,  1.4197e+00,  9.8263e-01,
         -2.6938e+00,  3.5131e-01, -3.2163e+00, -2.0520e+00,  1.4909e+00,
         -5.1048e-01,  2.2930e+00,  1.7767e+00,  1.2660e+00, -1.2023e+00,
          1.0210e+00,  2.1272e+00,  1.9412e+00, -7.2169e-01, -1.0942e+00,
          5.6098e-01,  8.5617e-01, -2.6041e+00, -3.4140e-01,  1.0480e+00,
         -3.2334e+00,  1.2870e+00,  4.2056e+00,  1.9121e+00, -3.6331e+00,
         -2.0603e-01,  3.9785e+00, -1.4264e+00,  2.8781e+00, -1.6279e+00,
         -1.4402e+00, -1.2502e+00, -1.5159e+00,  1.4231e+00,  3.6022e+00,
         -2.2929e+00, -1.6529e+00,  2.1691e+00, -2.9211e+00,  4.9481e+00,
         -6.5014e-01,  1.7802e+00,  4.0214e-01, -1.7033e+00, -8.0618e-01,
          4.0348e-01, -3.7184e+00, -2.3596e+00,  5.7602e+00,  3.4933e+00,
         -2.2830e+00,  1.0530e+00, -7.3461e-02, -2.7757e-01, -9.5690e-01,
          3.2588e+00,  5.3695e+00,  9.5049e-01, -1.5083e+00, -4.0376e-01,
         -1.7594e+00,  9.3780e-01, -2.3245e+00,  1.1573e+00, -2.0230e+00,
         -3.6542e+00, -2.3061e+00,  2.7517e+00,  5.3795e-01, -2.4032e+00,
         -7.0541e-01,  2.7433e+00,  4.6562e-01, -2.9398e+00, -1.0223e+00,
          5.1170e+00, -5.6848e-01, -3.6499e-01,  1.1356e+00, -7.0496e-02,
         -3.2813e+00,  8.0403e-01, -1.2196e+00,  2.4812e-01,  2.4685e-01,
          1.9128e+00,  1.1711e+00,  8.5675e-01,  4.3483e+00,  7.1197e-01,
         -2.2541e+00,  1.6872e+00, -6.7939e-01, -1.6632e+00,  2.4557e+00,
          1.5843e+00,  1.9780e+00,  6.1483e+00,  4.3390e+00, -3.3293e+00,
          4.2037e+00, -1.5235e+00, -1.6272e+00,  4.9263e+00,  1.3728e+00,
         -2.3752e+00,  1.9309e+00,  5.1698e-01, -1.2683e+00, -3.8753e+00,
         -1.8317e+00,  1.0702e+00,  2.3376e+00,  4.7236e+00, -1.4593e+00,
          1.7492e-01,  6.2059e-01,  4.7310e+00, -2.2662e+00, -1.1448e+00,
          2.7738e-01,  3.0607e-01,  2.4029e+00,  3.2488e+00, -7.6273e-01,
          3.9841e+00, -2.3903e+00, -4.5305e-01,  2.9868e+00,  3.6084e+00,
         -2.3392e+00,  3.6828e+00,  7.3610e-02, -3.3392e-01, -3.6364e-01,
          3.9139e+00,  5.4005e+00,  1.5953e-01, -1.2361e+00, -1.4498e+00,
          3.5165e+00, -1.2136e+00,  2.5417e+00,  1.6015e+00,  3.4600e+00,
          1.6605e-01, -2.7860e-01,  1.3028e+00,  3.7431e+00,  1.3863e+00,
         -4.0016e-01, -3.2712e+00, -1.0811e+00,  4.5512e+00, -1.4616e+00,
         -1.4096e+00, -2.5472e+00,  5.9771e+00,  9.5009e-01,  1.8813e+00,
          1.4303e+00,  7.7858e-01, -1.1297e+00, -6.9018e-01,  1.1469e+00,
          3.2384e+00,  1.0971e+00,  1.2104e+00,  1.3188e+00,  4.3900e+00,
         -1.1737e+00,  2.8809e-01,  3.5053e+00, -6.2883e-02,  1.9540e+00,
         -1.4618e+00, -2.5913e+00, -3.3726e+00, -4.1855e+00,  3.3018e+00,
          3.0254e+00,  2.9360e+00, -1.2147e+00,  1.6948e+00,  5.0392e+00,
          2.2176e+00,  5.2323e+00, -2.2589e+00,  5.0479e+00, -3.1331e+00,
         -3.1453e-01, -6.7421e-01, -1.2773e+00, -2.5829e-02, -2.0382e+00,
         -4.1936e+00, -2.8882e+00, -3.6026e+00,  1.2806e+00, -7.8570e-01,
         -8.6077e-01, -1.1403e+00,  1.7865e+00,  2.8529e+00, -2.1014e+00,
         -1.0467e+00,  2.4681e+00, -2.6450e+00, -3.6519e+00, -5.2010e-01,
          1.1036e+00, -4.7762e-01,  1.8146e+00,  2.3480e+00, -2.1583e+00,
          6.4939e-01,  2.1731e+00,  2.7497e-01,  1.5076e+00, -4.5026e-01,
          1.8754e+00,  1.8716e+00, -3.3194e+00, -3.5876e-01,  3.1620e+00,
          2.0918e+00,  3.9285e+00,  3.9967e+00, -2.1804e+00,  3.0969e-01,
          2.3221e+00, -2.2693e+00, -2.4853e+00,  2.7077e+00,  4.0424e+00,
          1.0785e-02,  5.3624e+00, -5.5197e-01, -2.1717e+00, -2.4544e+00,
          3.9087e-01, -2.6499e+00, -1.8299e+00,  4.6018e+00, -2.1837e+00,
          1.4663e+00,  1.2722e-01, -5.9861e-01, -3.7811e+00, -4.5002e+00,
         -1.8202e+00,  5.3597e+00, -1.2381e-02,  6.9553e-01,  4.3965e+00,
          4.8307e-01,  4.2457e-02,  2.0145e+00,  3.5718e+00, -1.0598e+00,
          2.9786e+00, -5.0593e-01, -2.6932e+00, -6.4401e-01,  1.3499e+00,
         -2.8425e+00,  1.6750e+00,  1.2785e+00,  2.5706e+00,  1.5395e+00,
         -1.2841e+00,  4.2666e+00,  5.0945e+00,  3.2156e+00,  3.5777e+00,
         -2.1691e+00, -1.0432e+00, -5.0443e-02, -1.2389e+00,  6.8680e+00,
          2.9516e+00, -6.2351e-01,  2.4912e-01,  1.0023e-01,  3.5099e+00,
          4.2556e+00, -8.3254e-01,  1.3262e+00, -4.1842e+00, -1.0329e+00,
         -2.8060e+00,  7.4420e-01, -1.1670e+00,  3.2181e+00,  1.8778e-01,
         -1.3594e+00,  1.5356e-01, -3.6500e-01,  1.1616e+00,  1.4017e+00,
          1.2900e+00, -1.8130e-02,  1.0509e-01,  4.0673e-01,  2.8675e+00,
          6.6382e-01,  1.5518e+00,  1.1698e+00,  3.9444e-01,  2.3186e-01,
         -3.3740e-01, -1.4047e+00,  4.9714e+00, -6.3103e-01,  2.0812e+00,
         -4.7459e-01, -1.3724e+00,  2.9282e+00,  1.0134e+00, -2.9074e+00,
          8.0848e-01, -2.2959e+00,  7.8033e-01,  2.0204e+00,  1.3782e+00,
          4.1147e+00,  8.6935e-01,  4.0647e-01,  1.2960e+00,  1.9599e+00,
         -1.9161e-03, -1.7434e+00,  9.5246e-01,  3.7834e+00, -1.0650e+00,
         -4.3286e-01,  1.0422e+00, -9.7037e-01,  6.2943e-01,  2.7755e+00,
         -9.5883e-01,  1.0547e+00,  2.5597e+00,  5.9441e+00,  2.7075e+00,
         -2.5439e+00,  1.8125e+00, -3.1393e+00, -1.0520e+00, -2.0764e+00,
         -8.1439e-01, -2.7721e+00, -1.6650e+00, -3.8030e-01, -2.9371e+00,
         -3.7679e+00, -1.5680e+00, -2.5615e+00, -2.8938e+00, -5.6249e-01,
          1.7167e+00, -8.5098e-01,  5.2249e+00,  5.7164e-01, -7.7632e-01,
         -1.2748e+00,  9.2097e-01,  5.5239e-02, -1.4349e+00, -4.7614e-01,
          3.3619e-01, -3.0062e-02, -2.2303e-01,  3.6195e+00,  5.0658e+00];
pyact = reshape(pyact',[],1);
%%
outtmp = squeeze(activations(matvgg,ones(224,224,3,1),'fc8'));
corr(pyact,outtmp)
%%
catimg = imread("E:\Monkey_Data\Generator_DB_Windows\nets\upconv\Cat.jpg");
cattsr = catimg(39:end-38,39:end-38,:);
outtmp = squeeze(activations(matvgg,cattsr,'fc8'));
corr(pyact,outtmp)
%%
figure;hold on;plot(outtmp);plot(pyact)